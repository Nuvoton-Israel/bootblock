/*----------------------------------------------------------------------------*/
/* SPDX-License-Identifier: GPL-2.0                                           */
/*                                                                            */
/* Copyright (c) 2010-2019 by Nuvoton Technology Corporation                  */
/* All rights reserved                                                        */
/*                                                                            */
/*----------------------------------------------------------------------------*/
/* File Contents:                                                             */
/*   tmc_drv.c                                                                */
/*            This file contains TMC module implementation                    */
/* Project:                                                                   */
/*            SWC HAL                                                         */
/*----------------------------------------------------------------------------*/


#include __CHIP_H_FROM_DRV()

#include "hal.h"

#include "tmc_drv.h"
#include "tmc_regs.h"



/*---------------------------------------------------------------------------------------------------------*/
/* Array of TMC_ counters                                                                                  */
/*---------------------------------------------------------------------------------------------------------*/
volatile static UINT32 TMC_tickCount[TMC_NUM_OF_PORTS] = {0};

#ifdef GIC_MODULE_TYPE
/*---------------------------------------------------------------------------------------------------------*/
/* Array of TMC_ interrupt handlers                                                                        */
/*---------------------------------------------------------------------------------------------------------*/
static /* GIC_ISR_t */ HANDLER_T TMC_handler[TMC_NUM_OF_PORTS] = {0};

/*---------------------------------------------------------------------------------------------------------*/
/* Array of TMC_ interrupt handlers args                                                                   */
/*---------------------------------------------------------------------------------------------------------*/
static UINT32 TMC_handler_args[TMC_NUM_OF_PORTS] = {0};

static void TMC_Isr (UINT32 timerNum);

#endif

/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_InternalHandler                                                                    */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  arg -                                                                                  */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine is internal TMC_ Irq Handler                                              */
/*---------------------------------------------------------------------------------------------------------*/
static void TMC_InternalHandler(UINT32 arg)
{
    UINT32 TMC_Num = (UINT32)arg;

    /*-----------------------------------------------------------------------------------------------------*/
    /* set start TMC_ value                                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    TMC_tickCount[TMC_Num]++;

    //return DEFS_STATUS_OK;
}


#ifdef GIC_MODULE_TYPE
/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_StartPeriodic                                                                      */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  TMC_Num        - TMC_ number                                                           */
/*                  ticksPerSec     - TMC_ frequency in hertz                                              */
/*                  tickHanlder     - Handler for TMC_ tick event. If NULL is given, internal event        */
/*                                    handler is used                                                      */
/*                  tickHandlerArg  - Argument to the handler                                              */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine initialization of the TMC_ to perform periodic event.                     */
/*                  If 'tickHandler' is given it is called every 'tickPerSec' tick.                        */
/*                  Otherwise internal handler is increasing internal tick counter for the given TMC_.     */
/*                  Its value can be read using TMC_GetTick function                                       */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_StartPeriodic (TIMER_CHANNEL_T TMC_Num, UINT32 ticksPerSec, HANDLER_T tickHanlder, void* tickHandlerArg)
{
    UINT32      TMC_Clk = 0;
    UINT32      loadVal  = 0;
    DEFS_STATUS  ret = DEFS_STATUS_OK;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return DEFS_STATUS_PARAMETER_OUT_OF_RANGE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Configuring the TMC_ clock                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    TMC_Clk = CLK_ConfigureTimerClock();

    /*-----------------------------------------------------------------------------------------------------*/
    /* Cleaning the status register                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    REG_WRITE(TCR0(TMC_Num), 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clearing the TMC_ counter                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    TMC_tickCount[TMC_Num]=0;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Periodic interrupt mode                                                                             */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_MODE, TCR_MODE_PERIODIC);

    /*-----------------------------------------------------------------------------------------------------*/
    /* set start TMC_ value                                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    if (ticksPerSec == 0)
    {
        loadVal = 0xFFFFFFFF;
        ret = DEFS_STATUS_CLK_ERROR;
    }
    else
    {
        loadVal = TMC_Clk / ticksPerSec;
    }
    REG_WRITE(TICR0(TMC_Num), loadVal);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Register handler                                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    if (tickHanlder != NULL)
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* Registering given handler if given                                                              */
        /*-------------------------------------------------------------------------------------------------*/
        TMC_handler[TMC_Num]         = tickHanlder;
        TMC_handler_args[TMC_Num]    = (UINT32)tickHandlerArg;
    }
    else
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* Registering internal handler if no handler given                                                */
        /*-------------------------------------------------------------------------------------------------*/
        TMC_handler[TMC_Num]         = TMC_InternalHandler;
        TMC_handler_args[TMC_Num]    = (UINT32)TMC_Num;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Setting Interrupt muxing                                                                            */
    /*-----------------------------------------------------------------------------------------------------*/
    GIC_EnableInt(TMC_INTERRUPT(TMC_Num), TRUE);


#if !defined(NO_INTERNAL_IRQ_HANDLER)
    GIC_InstallHandler(TMC_INTERRUPT(TMC_Num), TMC_Isr) ; // , TMC_Num);
    GIC_EnableInt(TMC_INTERRUPT(TMC_Num), TRUE);
#endif

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clear interrupt flag                                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_BIT(TISR(TMC_Num), TMC_PORT_IN_MODULE(TMC_Num));

    /*-----------------------------------------------------------------------------------------------------*/
    /* interrupt enable                                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_IE, 1);

    /*-----------------------------------------------------------------------------------------------------*/
    /* start TMC_                                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CEN, 1);

    return ret;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_StopPeriodic                                                                       */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  TMC_Num -                                                                              */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine stops the TMC_ started by startPeriodic routine                           */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_StopPeriodic(TIMER_CHANNEL_T TMC_Num)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return DEFS_STATUS_PARAMETER_OUT_OF_RANGE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* interrupt disable                                                                                   */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_IE, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* stop TMC_                                                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CEN, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clearing interrupt handlers                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    TMC_handler[TMC_Num]         = NULL;
    TMC_handler_args[TMC_Num]    = 0;

    return DEFS_STATUS_OK;
}
#endif


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_StartOneShot                                                                       */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  microSec -    number of micro seconds the TMC_ will count (to zero)                    */
/*                  TMC_Num -    the TMC_ number to use                                                    */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  Activate TMC_ in OneShot mode, no use of interrupts                                    */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_StartOneShot(TIMER_CHANNEL_T TMC_Num, UINT32 microSec)
{
    UINT32      TMC_Clk = 0;
     INT32      divisor  = 0;
    DEFS_STATUS  ret      = DEFS_STATUS_OK;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return DEFS_STATUS_PARAMETER_OUT_OF_RANGE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* if microSec is 0 nothing to do                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (microSec==0)
    {
        return DEFS_STATUS_OK;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Configure TMC_ source clock:                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    TMC_Clk = CLK_ConfigureTimerClock();

    /*-----------------------------------------------------------------------------------------------------*/
    /* Computing divisor                                                                                   */
    /*-----------------------------------------------------------------------------------------------------*/
    divisor = (TMC_Clk/_1MHz_)-1;

    if (divisor < 0)
    {
        divisor = 0;
        ret = DEFS_STATUS_CLK_ERROR;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Set prescaler to produce TMC_ tick each 1uSec:                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_PRESCALE, divisor);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clean status register:                                                                              */
    /*-----------------------------------------------------------------------------------------------------*/
    REG_WRITE(TCR0(TMC_Num), 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Set one shot mode                                                                                   */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_MODE, TCR_MODE_ONESHOT);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Load TMC_ value:                                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    REG_WRITE(TICR0(TMC_Num), microSec);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Start TMC_:                                                                                         */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CEN, 1);

    return ret;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_OneShotRunning                                                                     */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  TMC_Num -  number of TMC_ to check                                                     */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*              Checks whether the specified TMC_ is still running (counting)                              */
/*---------------------------------------------------------------------------------------------------------*/
BOOLEAN TMC_OneShotRunning(TIMER_CHANNEL_T TMC_Num)
{
    volatile UINT32 i=0;
    volatile UINT32 retval =0;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return FALSE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* HW BUG BYPASS:                                                                                      */
    /* Only 4th reading from CACT bit is consistent                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    for (i=0; i<4; ++i)
    {
        retval = READ_REG_FIELD(TCR0(TMC_Num), TCR_CACT);
    }

    return retval;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_Reset                                                                              */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine performs TMC_ reset                                                       */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_Reset (TIMER_CHANNEL_T TMC_Num)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return DEFS_STATUS_PARAMETER_OUT_OF_RANGE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* TMC_ reset                                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CRST, 1);

    return DEFS_STATUS_OK;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_GetTick                                                                            */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine returns TMC_ value                                                        */
/*---------------------------------------------------------------------------------------------------------*/
UINT32 TMC_GetTick(TIMER_CHANNEL_T TMC_Num)
{
    UINT32 tickCount;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return 0;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* interrupt disable                                                                                   */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_IE, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Reading TMC_ tick (critical section)                                                                */
    /*-----------------------------------------------------------------------------------------------------*/
    tickCount = TMC_tickCount[TMC_Num];

    /*-----------------------------------------------------------------------------------------------------*/
    /* interrupt enable                                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_IE, 1);

    return tickCount;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_GetHWTick                                                                          */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  TMC_Num -                                                                              */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine return the content of the HW ticking register                             */
/*---------------------------------------------------------------------------------------------------------*/
UINT32 TMC_GetHWTick(TIMER_CHANNEL_T TMC_Num)
{
    UINT32 hw_tick = 0;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        return 0;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* we stop the counter first, read the value and continue the count                                    */
    /* assuming the core clock is much faster than TMC_ clock, it shouldn't cause missed count             */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CEN, 0);
    hw_tick = REG_READ(TDR0(TMC_Num));
    SET_REG_FIELD(TCR0(TMC_Num), TCR_CEN, 1);

    return hw_tick;
}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_watchdogReset                                                                      */
/*                                                                                                         */
/* Parameters:      wd - one per timer module                                                              */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine performs watchdog reset                                                   */
/*---------------------------------------------------------------------------------------------------------*/
void TMC_WatchdogReset (TMC_MODULE_T wd)
{
    volatile INT i = 1;
    REG_WRITE(WTCR(wd), 0x83);
    while(i);
}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_WatchdogTouch                                                                      */
/*                                                                                                         */
/* Parameters:      wd - one per timer module                                                              */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                   This routine performs watchdog touch for a running WD                                 */
/*---------------------------------------------------------------------------------------------------------*/
void TMC_WatchdogTouch (TMC_MODULE_T wd)
{
    SET_REG_FIELD(WTCR(wd), WTCR_WTR, 1);
    return;
}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_StartWatchDog                                                                      */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  wd    -   watchdog number (one per module)                                             */
/*                  timeSec - todo!  currently it's 22 sec only.                                           */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine starts the wd                                                             */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_StartWatchDog (TMC_MODULE_T wd, UINT32 timeSec)
{
    UINT32 VAR_WTCR = 0;

    /*-----------------------------------------------------------------------------------------------------*/
    /* If clock was not configured (warm boot, skip init) - need to set the timer clock.                   */
    /*-----------------------------------------------------------------------------------------------------*/
    if ( CHIP_CfgWasDone() == FALSE)
    {
        CLK_ConfigureTimerClock();
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* SW reset the timer                                                                                  */
    /*-----------------------------------------------------------------------------------------------------*/
    CLK_ResetTIMER(wd);

    switch (wd)
    {
        case TMC_MODULE_0:
            CLK_ResetTIMER(0);  /* cahnnels 0 to 4 belong to TMC_0 */
            break;
        case TMC_MODULE_1:
            CLK_ResetTIMER(5);  /* cahnnels 5 to 9 belong to TMC_1 */
            break;
        case TMC_MODULE_2:
            CLK_ResetTIMER(10); /* cahnnels 10 to 14 belong to TMC_2 */
            break;

        default:
            return DEFS_STATUS_INVALID_PARAMETER;
    }


    /*-----------------------------------------------------------------------------------------------------*/
    /* Restart timer to a known state                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(  WTCR(wd), WTCR_WTR, 1);

    /*-----------------------------------------------------------------------------------------------------*/
    /* 0: When the debugger is active (DBGACK is high), the timer clock is stopped.                        */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_VAR_FIELD(VAR_WTCR, WTCR_FREEZE_EN, 0);
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTTME, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Config for 22 sec. TODO: set to any rate.                                                           */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTIS , WTIS_MODE_2);
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTCLK, WTCLK_DIV_2048);  /* check tables at tmc_regs.h. This gives 21.55sec */

    /*-----------------------------------------------------------------------------------------------------*/
    /* Enables Watchdog Timer reset function.                                                              */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTRE , 1);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Enable Watchdog                                                                                     */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTE, 1);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clear WD reset interrupt                                                                            */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTRF, 1);
    SET_VAR_FIELD(VAR_WTCR, WTCR_WTIF, 1);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Start the WD                                                                                        */
    /*-----------------------------------------------------------------------------------------------------*/
    REG_WRITE(WTCR(wd), VAR_WTCR);

    return DEFS_STATUS_OK;

}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_StopWatchDog                                                                       */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  wd    -   watchdog number (one per module)                                             */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine stops the wd and clear all pending interrupts                             */
/*---------------------------------------------------------------------------------------------------------*/
DEFS_STATUS TMC_StopWatchDog (TMC_MODULE_T wd)
{

    /*-----------------------------------------------------------------------------------------------------*/
    /* Disable WD                                                                                          */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(  WTCR(wd), WTCR_WTE, 0);

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clear interrupts                                                                                    */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_FIELD(  WTCR(wd), WTCR_WTIF, 1);
    SET_REG_FIELD(  WTCR(wd), WTCR_WTRF, 1);

    return DEFS_STATUS_OK;

}


#ifdef GIC_MODULE_TYPE
/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_Isr                                                                                */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  data - TMC_ number                                                                     */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine is TMC_ IRQ handler                                                       */
/*---------------------------------------------------------------------------------------------------------*/
static void TMC_Isr(UINT32 TMC_Num)
{
    /*-----------------------------------------------------------------------------------------------------*/
    /* Error handling                                                                                      */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_Num >= TMC_NUM_OF_PORTS)
    {
        ASSERT(FALSE);
        // return DEFS_STATUS_PARAMETER_OUT_OF_RANGE;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Checking if TMC   interrupt set                                                                     */
    /*-----------------------------------------------------------------------------------------------------*/
    if (!READ_REG_BIT(TISR(TMC_Num), TMC_PORT_IN_MODULE(TMC_Num)))
    {
        /*-------------------------------------------------------------------------------------------------*/
        /* If not, do nothing. (probably bad call to the function)                                         */
        /*-------------------------------------------------------------------------------------------------*/
        ASSERT(FALSE);
        //return DEFS_STATUS_FAIL; //  HAL_ERROR_NOT_HANDLED;
    }

    /*-----------------------------------------------------------------------------------------------------*/
    /* Executing the handler                                                                               */
    /*-----------------------------------------------------------------------------------------------------*/
    if (TMC_handler[TMC_Num] != NULL)
        TMC_handler[TMC_Num](TMC_handler_args[TMC_Num]) ;

    /*-----------------------------------------------------------------------------------------------------*/
    /* Clear interrupt                                                                                     */
    /*-----------------------------------------------------------------------------------------------------*/
    SET_REG_BIT(TISR(TMC_Num), TMC_PORT_IN_MODULE(TMC_Num));

   // return DEFS_STATUS_OK;
}
#endif

/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_PrintRegs                                                                          */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine prints the module registers                                               */
/*---------------------------------------------------------------------------------------------------------*/
void TMC_PrintRegs (void)
{
    UINT i;

    HAL_PRINT("/*--------------*/\n");
    HAL_PRINT("/*     TMC      */\n");
    HAL_PRINT("/*--------------*/\n\n");

    for (i = 0; i < TMC_NUM_OF_MODULES; i++)
    {
        TMC_PrintModuleRegs((TMC_MODULE_T)i);
    }
}

/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_PrintModuleRegs                                                                    */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  wd - The watchdog number (module) to be printed.                                       */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine prints the module instance registers                                      */
/*lint -e{715}      Supress 'wd' not referenced                                                            */
/*---------------------------------------------------------------------------------------------------------*/
void TMC_PrintModuleRegs (TMC_MODULE_T wd)
{
    ASSERT(wd < TMC_NUM_OF_MODULES);

    HAL_PRINT("TMC%d:\n", wd);
    HAL_PRINT("------\n");
    HAL_PRINT("TCR0                = 0x%08X\n", REG_READ(TCR0(wd)));
    HAL_PRINT("TCR1                = 0x%08X\n", REG_READ(TCR1(wd)));
    HAL_PRINT("TCR2                = 0x%08X\n", REG_READ(TCR2(wd)));
    HAL_PRINT("TCR3                = 0x%08X\n", REG_READ(TCR3(wd)));
    HAL_PRINT("TCR4                = 0x%08X\n", REG_READ(TCR4(wd)));
    HAL_PRINT("TICR0               = 0x%08X\n", REG_READ(TICR0(wd)));
    HAL_PRINT("TICR1               = 0x%08X\n", REG_READ(TICR1(wd)));
    HAL_PRINT("TICR2               = 0x%08X\n", REG_READ(TICR2(wd)));
    HAL_PRINT("TICR3               = 0x%08X\n", REG_READ(TICR3(wd)));
    HAL_PRINT("TICR4               = 0x%08X\n", REG_READ(TICR4(wd)));
    HAL_PRINT("TDR0                = 0x%08X\n", REG_READ(TDR0(wd)));
    HAL_PRINT("TDR1                = 0x%08X\n", REG_READ(TDR1(wd)));
    HAL_PRINT("TDR2                = 0x%08X\n", REG_READ(TDR2(wd)));
    HAL_PRINT("TDR3                = 0x%08X\n", REG_READ(TDR3(wd)));
    HAL_PRINT("TDR4                = 0x%08X\n", REG_READ(TDR4(wd)));
    HAL_PRINT("TISR                = 0x%08X\n", REG_READ(TISR(wd)));
    HAL_PRINT("WTCR                = 0x%08X\n", REG_READ(WTCR(wd)));

    HAL_PRINT("\n");
}

/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TMC_PrintVersion                                                                       */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine prints the module version                                                 */
/*---------------------------------------------------------------------------------------------------------*/
void TMC_PrintVersion (void)
{
    HAL_PRINT("TMC         = %d\n", TMC_MODULE_TYPE);
}

